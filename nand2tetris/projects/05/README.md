

## 目标

现代计算机的定义如下：

![Computer](/img/ch05_Computer.png)

接下来基于ch01-03中已经构建好的芯片和ch04中的CPU指令设计，构建以下芯片，最后构建完整的计算机硬件平台：

| 名称  | 备注 |
| ----- | ----- |
| CPU | CPU芯片 |
| Screen | 屏幕I/O映像 |
| Keyboard | 键盘I/O映像 |
| Memory | 数据内存 |
| ROM32K | 指令内存 |
| Computer | 计算机 |


并在完成的计算机硬件平台上，测试以下机器语言程序：

| 机器语言程序文件  | 备注 |
| ----- | ----- |
| Add.hack | 实现两个常数相加 |
| Max.hack | 比较最大值 |
| Rect.hack | 屏幕左上角绘出黑色矩形框 |


## 背景知识

+ 存储程序理念：
	1. 基于特定硬件构建的计算机平台，能够执行一组特定的指令，又叫指令集；
	2. 与计算机底层硬件一样，指令集也被视为计算机的一种构件；
	3. 利用指令集这种构件，我们可以编排出一组满足我们特定目的的操作，这组操作通常被叫做程序；
	4. 我们可以把这种程序和数据一样，存储起来，供计算机平台读取执行，并把它叫做软件；
	5. 这样，如果把一种软件替换为另一种，那么基于特定硬件构建的计算机平台就可以读取执行不同的软件，进而实现不同的功能。

+ 冯·诺伊曼体系结构：如下图所示，为冯·诺伊曼体系结构概念，是典型的存储程序理念体现。CPU为该体系结构核心，
	1. 它与内存单元（分为指令内存和数据内存两种，分别用于存储数据和指令）进行交互；
	2. 它从输入设备接收数据；
	3. 它向输出设备发送数据；

	![Feng](/img/ch05_Feng.png)
	
+ 读取-执行循环（read-execute cycle）：
	1. 读取下一条指令；
	2. 解码指令；
	3. 执行指令对应的计算操作;
	4. goto 1。

+ 通用/专用计算机：通用计算机内存可以动态加在不同的一组指令，去实现各种各样的功能；专用计算机内存被烧写进一组指令，只能读取执行，如果要实现其他的功能，需要更换内存，比如早期的小霸王游戏机。


## 实现

注：每个芯片可能有多种不同的实现，下面的实现，会尽可能的使用已经构建好的元件，以体现抽象、模块化、封装的理念。

### CPU芯片

CPU芯片指令集设计如下：

![CPU_Instruction](/img/ch05_CPU_Instruction.png)

CPU芯片实现如下：

![CPU](/img/ch05_CPU.png)

### 屏幕I/O映像：Screen

使用内建的Screen芯片，映射为8K的RAM存储单元：

![Screen](/img/ch05_Screen.png)

### 键盘I/O映像：Keyboard

使用内建的Keyboard芯片，映射为16bit的RAM存储单元，即一个16位寄存器：

![Keyboard](/img/ch05_Keyboard.png)

### 数据内存：Memory

![Memory](/img/ch05_Memory.png)

### 指令内存：ROM32K

使用内建的ROM32K芯片，内部实现见RAMn芯片的实现，不同的是，ROM是只读内存，用于烧录编译之后的机器语言指令：

![ROM32K](/img/ch05_ROM32K.png)

### Computer

![Computer_Impl](/img/ch05_Computer_Impl.png)

### 机器语言测试

增加以下汇编代码、编译之后的二进制机器码及测试文件：

```
ComputerHello.tst
Hello.asm          // 实现在屏幕左上角显示大些字母H的功能
Hello.hack
```


## 小结

现代计算机通常会区分复杂指令集、精简指令集，他们之间的区别在于，前者注重性能，提供了丰富、详细的指令集，后者注重硬件速度，提供了简单的指令集。这里实现的计算机平台的CPU指令集，非常简单，不站队。

	